<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulador de Casos Clínicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>
<body>
  <header class="topbar">
    <div class="logo">Simu<span>LACIR</span></div>
    <nav class="tabs-nav">
      <button class="tab-link active" data-tab="inicio">Início</button>
      <button class="tab-link" data-tab="casos">Casos</button>
      <button class="tab-link" data-tab="liga">Área do ligante</button>
      <button class="tab-link" data-tab="upload">Upload</button>
    </nav>
  </header>

  <main>
    <section id="tab-inicio" class="tab-section active">
      <!-- HERO / APRESENTAÇÃO -->
      <section class="hero">
        <div class="hero-text">
          <h1>SimuLACIR – simulador de casos clínicos da LACIR Bahia</h1>
          <p>
            Uma plataforma em desenvolvimento para treinar decisões em cirurgia e
            urgências, com casos interativos, alternativas comentadas e feedback imediato.
          </p>
          <a href="#caso-demo" class="btn-primary">Começar pelo caso de demonstração</a>
        </div>
      </section>

      <!-- SEÇÃO SOBRE -->
      <section id="sobre" class="section">
        <h2>Bem-vindo ao SimuLACIR</h2>
        <p>
          O <strong>SimuLACIR</strong> é o simulador de casos clínicos da
          <strong>Liga Acadêmica de Cirurgia da Bahia (LACIR)</strong>.
          Ele foi criado para que estudantes de medicina possam treinar
          raciocínio clínico em um ambiente seguro, interativo e focado em
          tomada de decisão.
        </p>

        <p>
          Nesta demonstração inicial, oferecemos um caso clínico básico para
          ilustrar a ideia. No futuro, queremos disponibilizar uma biblioteca
          com dezenas de casos, níveis de dificuldade, histórico e feedback
          personalizado.
        </p>

        <div class="cards-grid">
          <div class="info-card">
            <h3>Casos realistas</h3>
            <p>
              Enunciados curtos, objetivos e próximos do dia a dia, com alternativas de conduta e explicações.
            </p>
          </div>
          <div class="info-card">
            <h3>Feedback imediato</h3>
            <p>
              Ao clicar em uma opção, você recebe comentários e referências rápidas sobre a decisão.
            </p>
          </div>
          <div class="info-card">
            <h3>Foco em tomada de decisão</h3>
            <p>
              Não é apenas memorizar: queremos reforçar o raciocínio clínico e a escolha da melhor conduta.
            </p>
          </div>
        </div>
      </section>
    </section>

    <section id="tab-casos" class="tab-section">
      <section id="caso-demo" class="section">
        <h2>Casos clínicos</h2>
        <p class="section-subtitle">
          Carregue um caso pela aba Upload, visualize-o aqui e clique para iniciar a simulação.
        </p>

        <div class="case-layout">
          <aside class="case-list">
            <h4>Casos disponíveis</h4>
            <div id="lista-casos-avancados">
              <p class="lista-vazia">Nenhum caso carregado. Use a aba Upload.</p>
            </div>
          </aside>

          <div class="case-card" id="simulador-avancado" style="display: none">
            <h3 id="titulo-caso-avancado">Selecione um caso para iniciar</h3>
            <p id="descricao-caso-avancado">Aguardando caso carregado via Upload.</p>

            <div class="etapa-bloco">
              <p id="enunciado-etapa"></p>
              <ul id="alternativas-lista" class="opcoes-lista"></ul>
            </div>

            <div id="feedback-etapa" class="resultado">
              <p>Escolha uma alternativa para ver o feedback.</p>
            </div>

            <button id="proxima-etapa-btn" class="btn-primary" type="button" style="display: none">
              Próxima etapa
            </button>
          </div>
        </div>
      </section>
    </section>

    <section id="tab-liga" class="tab-section">
      <h2>Área do ligante – SimuLACIR</h2>
      <p>
        Esta área é destinada aos ligantes da Liga Acadêmica de Cirurgia da Bahia (LACIR).
        Aqui serão disponibilizados casos oficiais com acesso restrito e trilhas de estudo específicas.
      </p>

      <div class="ligante-login">
        <div class="ligante-login__header">
          <div class="ligante-login__badge"><i class="fa-solid fa-user-shield"></i></div>
          <div>
            <p class="ligante-login__title">Acesso seguro para ligantes</p>
            <small>Use a senha da liga para liberar o conteúdo restrito.</small>
          </div>
        </div>
        <label for="senha-ligante">Senha do ligante:</label>
        <div class="ligante-login-row">
          <div class="input-embbed">
            <i class="fa-solid fa-lock"></i>
            <input type="password" id="senha-ligante" placeholder="Digite a senha da área do ligante" />
          </div>
          <button id="btn-login-ligante" type="button" class="btn-primary">
            <i class="fa-solid fa-arrow-right-to-bracket"></i>
            <span>Entrar</span>
          </button>
        </div>
        <p id="ligante-mensagem" class="ligante-mensagem" aria-live="polite">
          <span class="msg-icon">ℹ️</span>
          <span>Apenas ligantes autorizados podem acessar os casos restritos.</span>
        </p>
      </div>

      <div id="ligante-conteudo" class="ligante-conteudo oculto" aria-live="polite">
        <div class="ligante-conteudo__header">
          <div>
            <p class="ligante-conteudo__eyebrow"><i class="fa-solid fa-shield-heart"></i> Conteúdo seguro</p>
            <h3>Casos restritos da LACIR</h3>
            <p>
              Acesso liberado. Em breve, esta área exibirá todos os casos com
              <code>nivelAcesso: "liga"</code> ou <code>"seletivo"</code>, carregados a partir dos arquivos oficiais.
            </p>
          </div>
          <div class="ligante-status-chip"><i class="fa-solid fa-circle-check"></i> Acesso validado</div>
        </div>

        <div class="ligante-conteudo__grid">
          <div class="ligante-conteudo__box">
            <div class="ligante-conteudo__info">
              <i class="fa-solid fa-graduation-cap"></i>
              <div>
                <p class="ligante-conteudo__label">Trilha de estudo</p>
                <p>Organize revisões e selecione o caso avançado ideal para treinar.</p>
              </div>
            </div>
            <div class="ligante-conteudo__pillset">
              <span class="pill"><i class="fa-solid fa-bolt"></i> Condutas rápidas</span>
              <span class="pill"><i class="fa-solid fa-heart-pulse"></i> Emergências</span>
              <span class="pill"><i class="fa-solid fa-stethoscope"></i> Pós-operatório</span>
            </div>
          </div>
          <div class="ligante-conteudo__box ligante-conteudo__box--shadow">
            <div class="ligante-conteudo__box-header">
              <h4>Casos clínicos avançados</h4>
              <button class="ghost-button" type="button" id="liga-refresh">
                <i class="fa-solid fa-rotate"></i>
                Atualizar lista
              </button>
            </div>
            <div id="liga-cases-grid" class="liga-cases-grid"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-upload" class="tab-section">
      <h2>Upload de casos clínicos</h2>
      <p>
        Carregue casos clínicos em formato JSON compatível com o SimuLACIR. O arquivo é lido pelo navegador e o caso fica
        disponível imediatamente na aba Casos, sem necessidade de backend.
      </p>

      <h3>1. Baixe o modelo de caso</h3>
      <p>
        O formato oficial de caso é o modelo complexo. Use o arquivo abaixo como referência:
      </p>
      <p>
        <a href="docs/caso-modelo-avancado.json" download>Baixar modelo de caso avançado (JSON)</a>
      </p>

      <h3>2. Carregue um arquivo de caso</h3>
      <p>
        O arquivo será validado e adicionado à lista de casos para ser iniciado na aba Casos. A simulação só começa quando
        você clicar em "Iniciar simulação" na lista.
      </p>

      <div class="upload-box">
        <label for="arquivo-caso-avancado">Selecione um arquivo de caso avançado (.json):</label>
        <input type="file" id="arquivo-caso-avancado" accept=".json,application/json">
        <button id="btn-carregar-caso-avancado" type="button" class="btn-primary">
          Adicionar caso à lista
        </button>
        <p id="upload-estado" aria-live="polite"></p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>Projeto em desenvolvimento — Simulador de Casos Clínicos.</p>
  </footer>

  <button class="theme-toggle" id="theme-toggle" type="button" aria-label="Alternar modo escuro">
    <i class="fa-solid fa-moon"></i>
  </button>

  <script>
    const tabLinks = document.querySelectorAll(".tab-link");
    const tabSections = document.querySelectorAll(".tab-section");

    tabLinks.forEach((link) => {
      link.addEventListener("click", () => {
        const tab = link.getAttribute("data-tab");
        tabLinks.forEach((l) => l.classList.remove("active"));
        tabSections.forEach((sec) => sec.classList.remove("active"));

        link.classList.add("active");
        const alvo = document.getElementById("tab-" + tab);
        if (alvo) {
          alvo.classList.add("active");
        }
      });
    });
    // Estado global dos casos avançados
    let casosAvancados = [];
    let casoAvancadoAtual = null;
    let etapaAtualId = null;

    // Referências aos elementos da aba "Casos"
    const listaCasosAvancadosEl = document.getElementById("lista-casos-avancados");
    const simuladorAvancadoEl = document.getElementById("simulador-avancado");
    const tituloCasoAvancadoEl = document.getElementById("titulo-caso-avancado");
    const descricaoCasoAvancadoEl = document.getElementById("descricao-caso-avancado");
    const enunciadoEtapaEl = document.getElementById("enunciado-etapa");
    const alternativasListaEl = document.getElementById("alternativas-lista");
    const feedbackEtapaEl = document.getElementById("feedback-etapa");
    const proximaEtapaBtn = document.getElementById("proxima-etapa-btn");

    // Validações básicas do caso avançado
    function validarCasoAvancado(caso) {
      if (!caso) {
        throw new Error("O caso avançado não foi fornecido.");
      }

      // Aceita o formato legado com propriedade 'fluxo'
      if (!caso.etapas && Array.isArray(caso.fluxo)) {
        caso.etapas = caso.fluxo.map((etapa, indice) => ({
          ...etapa,
          id: etapa.id || etapa.etapa || `etapa-${indice + 1}`,
          tipo: etapa.tipo || "alternativas",
        }));
      }

      if (!Array.isArray(caso.etapas)) {
        throw new Error("O arquivo de caso avançado deve conter uma lista 'etapas'.");
      }

      caso.etapas.forEach((etapa, indice) => {
        if (!etapa || !etapa.id || !etapa.tipo) {
          throw new Error(`A etapa ${indice + 1} precisa ter 'id' e 'tipo'.`);
        }

        if (!Array.isArray(etapa.alternativas)) {
          etapa.alternativas = [];
        }
      });

      if (!caso.etapaInicialId && caso.etapas[0]) {
        caso.etapaInicialId = caso.etapas[0].id;
      }
    }

    function registrarCasoAvancado(jsonCaso) {
      validarCasoAvancado(jsonCaso);
      casosAvancados.push(jsonCaso);
      atualizarListaDeCasos();
    }

    function atualizarListaDeCasos() {
      if (!listaCasosAvancadosEl) return;

      listaCasosAvancadosEl.innerHTML = "";

      if (casosAvancados.length === 0) {
        const vazio = document.createElement("p");
        vazio.className = "lista-vazia";
        vazio.textContent = "Nenhum caso carregado. Use a aba Upload.";
        listaCasosAvancadosEl.appendChild(vazio);
        return;
      }

      casosAvancados.forEach((caso, index) => {
        const card = document.createElement("div");
        card.className = "caso-card";
        card.innerHTML = `
          <h3>${caso.titulo || "Caso sem título"}</h3>
          <p>${caso.descricao || caso.contexto || ""}</p>
          <button type="button">Iniciar simulação</button>
        `;

        card.querySelector("button").onclick = () => iniciarCasoAvancado(index);
        listaCasosAvancadosEl.appendChild(card);
      });
    }

    function iniciarCasoAvancado(index) {
      casoAvancadoAtual = casosAvancados[index];
      etapaAtualId = casoAvancadoAtual.etapaInicialId;

      if (simuladorAvancadoEl) {
        simuladorAvancadoEl.style.display = "block";
      }

      renderizarEtapaAtual();
    }

    function obterEtapaAtual() {
      return casoAvancadoAtual?.etapas.find((etapa) => etapa.id === etapaAtualId) || null;
    }

    function limparFeedbackEtapa() {
      if (feedbackEtapaEl) {
        feedbackEtapaEl.textContent = "Escolha uma alternativa para ver o feedback.";
      }

      if (proximaEtapaBtn) {
        proximaEtapaBtn.style.display = "none";
        proximaEtapaBtn.dataset.proximaId = "";
      }
    }

    function obterProximaEtapaId(etapa, alternativaSelecionada) {
      if (alternativaSelecionada?.proximaEtapaId) return alternativaSelecionada.proximaEtapaId;
      if (etapa?.proximaEtapaId) return etapa.proximaEtapaId;

      if (!casoAvancadoAtual) return null;
      const indiceAtual = casoAvancadoAtual.etapas.findIndex((item) => item.id === etapa?.id);
      return casoAvancadoAtual.etapas[indiceAtual + 1]?.id || null;
    }

    function renderizarEtapaAtual() {
      if (!casoAvancadoAtual || !simuladorAvancadoEl) {
        return;
      }

      const etapaAtual = obterEtapaAtual();

      if (!etapaAtual) {
        if (feedbackEtapaEl) {
          feedbackEtapaEl.textContent = "Simulação concluída.";
        }
        if (alternativasListaEl) {
          alternativasListaEl.innerHTML = "";
        }
        return;
      }

      if (tituloCasoAvancadoEl) {
        tituloCasoAvancadoEl.textContent = casoAvancadoAtual.titulo || "Caso clínico";
      }

      if (descricaoCasoAvancadoEl) {
        descricaoCasoAvancadoEl.textContent =
          casoAvancadoAtual.descricao || casoAvancadoAtual.contexto || "Caso carregado via Upload.";
      }

      if (enunciadoEtapaEl) {
        enunciadoEtapaEl.textContent = etapaAtual.enunciado || etapaAtual.titulo || "";
      }

      limparFeedbackEtapa();

      if (alternativasListaEl) {
        alternativasListaEl.innerHTML = "";

        etapaAtual.alternativas.forEach((alternativa) => {
          const item = document.createElement("li");
          const btn = document.createElement("button");
          btn.className = "opcao-btn";
          btn.textContent = `${alternativa.id || ""}) ${alternativa.texto || alternativa.descricao || "Opção"}`;

          btn.addEventListener("click", () => {
            const proximaId = obterProximaEtapaId(etapaAtual, alternativa);

            if (feedbackEtapaEl) {
              feedbackEtapaEl.textContent = alternativa.feedback || "Sem feedback disponível para esta alternativa.";
            }

            if (proximaEtapaBtn) {
              if (proximaId) {
                proximaEtapaBtn.dataset.proximaId = proximaId;
                proximaEtapaBtn.style.display = "inline-flex";
              } else {
                proximaEtapaBtn.style.display = "none";
              }
            }

            if (proximaId && !proximaEtapaBtn) {
              etapaAtualId = proximaId;
              renderizarEtapaAtual();
            }
          });

          item.appendChild(btn);
          alternativasListaEl.appendChild(item);
        });
      }
    }

    if (proximaEtapaBtn) {
      proximaEtapaBtn.addEventListener("click", () => {
        const proximaId = proximaEtapaBtn.dataset.proximaId;
        if (proximaId) {
          etapaAtualId = proximaId;
          renderizarEtapaAtual();
        }
      });
    }

    const SENHA_LIGANTE = "simulacir2025"; // senha padrão por enquanto
    let liganteDesbloqueado = false;

    const inputSenhaLigante = document.getElementById("senha-ligante");
    const btnLoginLigante = document.getElementById("btn-login-ligante");
    const mensagemLigante = document.getElementById("ligante-mensagem");
    const conteudoLigante = document.getElementById("ligante-conteudo");
    const ligaCasesGrid = document.getElementById("liga-cases-grid");
    const btnRefreshCasos = document.getElementById("liga-refresh");

    const casosAvancadosLiga = [
      {
        nome: "Trauma abdominal avançado",
        nivel: "ligante",
        tags: ["trauma", "abdome agudo", "FAST"],
      },
      {
        nome: "Choque séptico no pós-operatório",
        nivel: "seletivo",
        tags: ["UTI", "fluido terapia", "antibiótico"],
      },
      {
        nome: "Politrauma em via aérea difícil",
        nivel: "liga",
        tags: ["vias aéreas", "Ranson", "intubação"],
      },
      {
        nome: "Síndrome compartimental pós fratura",
        nivel: "seletivo",
        tags: ["ortopedia", "perfusão", "compartimento"],
      },
    ];

    function mostrarMensagemLigante(tipo, texto) {
      if (!mensagemLigante) return;

      const icone = tipo === "erro" ? "⚠️" : tipo === "sucesso" ? "✅" : "ℹ️";

      mensagemLigante.classList.remove("is-error", "is-success", "visible");
      mensagemLigante.innerHTML = `<span class="msg-icon">${icone}</span><span>${texto}</span>`;

      if (tipo === "erro") {
        mensagemLigante.classList.add("is-error");
      } else if (tipo === "sucesso") {
        mensagemLigante.classList.add("is-success");
      }

      // Reinicia transição
      mensagemLigante.offsetHeight;
      mensagemLigante.classList.add("visible");
    }

    function revelarConteudoLigante(ativo) {
      if (!conteudoLigante) return;

      if (ativo) {
        conteudoLigante.classList.remove("oculto");
        requestAnimationFrame(() => conteudoLigante.classList.add("revelado"));
      } else {
        conteudoLigante.classList.add("oculto");
        conteudoLigante.classList.remove("revelado");
      }
    }

    function atualizarEstadoLigante() {
      if (!conteudoLigante || !mensagemLigante) return;

      if (liganteDesbloqueado) {
        revelarConteudoLigante(true);
        mostrarMensagemLigante("sucesso", "Acesso liberado. Você está vendo a área restrita para ligantes.");
      } else {
        revelarConteudoLigante(false);
        mostrarMensagemLigante("info", "Apenas ligantes autorizados podem acessar os casos restritos.");
      }
    }

    function renderCasosAvancados(lista) {
      if (!ligaCasesGrid) return;
      ligaCasesGrid.innerHTML = "";

      lista.forEach((caso) => {
        const card = document.createElement("article");
        card.className = "advanced-card";
        card.innerHTML = `
          <div class="advanced-card__header">
            <p class="advanced-card__title">${caso.nome}</p>
            <span class="advanced-card__nivel">${caso.nivel}</span>
          </div>
          <div class="advanced-card__tags">
            ${caso.tags.map((tag) => `<span class="advanced-card__tag">${tag}</span>`).join("")}
          </div>
        `;

        const iniciarBtn = document.createElement("button");
        iniciarBtn.className = "btn-primary";
        iniciarBtn.type = "button";
        iniciarBtn.innerHTML = '<i class="fa-solid fa-play"></i><span>Iniciar caso</span>';

        iniciarBtn.addEventListener("click", () => {
          mostrarMensagemLigante("sucesso", `Iniciando ${caso.nome} (${caso.nivel}).`);
        });

        card.appendChild(iniciarBtn);
        ligaCasesGrid.appendChild(card);
      });
    }

    if (btnRefreshCasos) {
      btnRefreshCasos.addEventListener("click", () => {
        const listaMisturada = [...casosAvancadosLiga].sort(() => Math.random() - 0.5);
        renderCasosAvancados(listaMisturada);
        mostrarMensagemLigante("info", "Lista de casos atualizada.");
      });
    }

    if (btnLoginLigante && inputSenhaLigante) {
      btnLoginLigante.addEventListener("click", () => {
        if (inputSenhaLigante.value === SENHA_LIGANTE) {
          liganteDesbloqueado = true;
          atualizarEstadoLigante();
          renderCasosAvancados(casosAvancadosLiga);
        } else {
          liganteDesbloqueado = false;
          atualizarEstadoLigante();
          mostrarMensagemLigante("erro", "Senha incorreta. Tente novamente.");
        }
      });

      // Permitir login com Enter
      inputSenhaLigante.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          btnLoginLigante.click();
        }
      });
    }

    const inputCasoAvancado = document.getElementById("arquivo-caso-avancado");
    const btnCarregarCasoAvancado = document.getElementById("btn-carregar-caso-avancado");
    const uploadEstado = document.getElementById("upload-estado");

    // Carrega caso avançado a partir de arquivo JSON enviado pelo usuário
    if (btnCarregarCasoAvancado && inputCasoAvancado && uploadEstado) {
      btnCarregarCasoAvancado.addEventListener("click", () => {
        const arquivo = inputCasoAvancado.files?.[0];

        uploadEstado.textContent = "";
        uploadEstado.style.color = "";

        if (!arquivo) {
          uploadEstado.textContent = "Selecione um arquivo JSON para carregar um caso.";
          uploadEstado.style.color = "#b91c1c";
          return;
        }

        const reader = new FileReader();

        reader.onload = () => {
          try {
            const conteudo = reader.result ? reader.result.toString() : "";
            const jsonCaso = JSON.parse(conteudo);
            registrarCasoAvancado(jsonCaso);

            const tituloMensagem = jsonCaso.titulo || arquivo.name;
            uploadEstado.style.color = "#15803d";
            uploadEstado.textContent = `✅ Caso "${tituloMensagem}" carregado e disponível na aba Casos.`;
          } catch (erro) {
            console.error(erro);
            uploadEstado.style.color = "#b91c1c";
            uploadEstado.textContent = `Erro ao carregar caso avançado: ${erro instanceof Error ? erro.message : "Conteúdo inválido."}`;
          }
        };

        reader.onerror = () => {
          uploadEstado.style.color = "#b91c1c";
          uploadEstado.textContent = "Não foi possível ler o arquivo selecionado.";
        };

        reader.readAsText(arquivo, "utf-8");
      });
    }

    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
    const themeToggle = document.getElementById("theme-toggle");

    function aplicarTema(tema) {
      document.body.dataset.theme = tema;
      localStorage.setItem("theme", tema);
      if (themeToggle) {
        themeToggle.innerHTML = tema === "dark" ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        themeToggle.setAttribute(
          "aria-label",
          tema === "dark" ? "Alternar para modo claro" : "Alternar para modo escuro"
        );
      }
    }

    const temaSalvo = localStorage.getItem("theme");
    const temaInicial = temaSalvo || (prefersDark.matches ? "dark" : "light");
    aplicarTema(temaInicial);

    if (themeToggle) {
      themeToggle.addEventListener("click", () => {
        const proximoTema = document.body.dataset.theme === "dark" ? "light" : "dark";
        aplicarTema(proximoTema);
      });
    }

    prefersDark.addEventListener("change", (event) => {
      const preferencia = event.matches ? "dark" : "light";
      if (!localStorage.getItem("theme")) {
        aplicarTema(preferencia);
      }
    });

    // Chamar ao carregar a página para garantir estado inicial
    atualizarEstadoLigante();
  </script>
</body>
</html>
